/*
===============================================================================
Quality Checks
===============================================================================

Script Purpose:
    This script performs comprehensive quality checks for data consistency,
    accuracy, and standardization across the SILVER layer.

    It also includes data validation logic for BRONZE layer data that is
    transformed and migrated into the SILVER layer.

    The checks include:
    - Null or duplicate primary keys
    - Unwanted spaces in string fields
    - Data standardization and consistency
    - Invalid date ranges and date order validation
    - Data consistency between related numeric fields

Usage Notes:
    - Execute this script after loading the Silver Layer.
    - Investigate and resolve any discrepancies returned by these checks.

===============================================================================
*/

USE DataWarehouse;

-- ============================================================================
-- Checking: silver.crm_cust_info
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Check for NULLs or Duplicate Primary Keys
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT 
    cst_id,
    COUNT(*) AS record_count
FROM silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1 OR cst_id IS NULL;

-- ---------------------------------------------------------------------------
-- Check for Unwanted Spaces in String Columns
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT cst_firstname
FROM silver.crm_cust_info
WHERE cst_firstname <> TRIM(cst_firstname);

SELECT cst_lastname
FROM silver.crm_cust_info
WHERE cst_lastname <> TRIM(cst_lastname);

SELECT cst_gndr
FROM silver.crm_cust_info
WHERE cst_gndr <> TRIM(cst_gndr);

SELECT cst_marital_status
FROM silver.crm_cust_info
WHERE cst_marital_status <> TRIM(cst_marital_status);

SELECT cst_key
FROM silver.crm_cust_info
WHERE cst_key <> TRIM(cst_key);

-- ---------------------------------------------------------------------------
-- Data Standardization & Consistency Checks
-- ---------------------------------------------------------------------------

SELECT DISTINCT cst_gndr
FROM silver.crm_cust_info;

SELECT DISTINCT cst_marital_status
FROM silver.crm_cust_info;

-- Preview Data
SELECT * FROM silver.crm_cust_info;


-- ============================================================================
-- Checking: silver.crm_prd_info
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Check for NULLs or Duplicate Primary Keys
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT 
    prd_id,
    COUNT(*) AS record_count
FROM silver.crm_prd_info
GROUP BY prd_id
HAVING COUNT(*) > 1 OR prd_id IS NULL;

-- ---------------------------------------------------------------------------
-- Check for Unwanted Spaces
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT prd_nm
FROM silver.crm_prd_info
WHERE prd_nm <> TRIM(prd_nm);

-- ---------------------------------------------------------------------------
-- Check for NULL or Negative Product Cost
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT prd_cost
FROM silver.crm_prd_info
WHERE prd_cost IS NULL OR prd_cost < 0;

-- ---------------------------------------------------------------------------
-- Data Standardization & Consistency
-- ---------------------------------------------------------------------------

SELECT DISTINCT prd_line
FROM silver.crm_prd_info;

-- ---------------------------------------------------------------------------
-- Check for Invalid Date Ranges
-- Expectation: End date must be >= start date
-- ---------------------------------------------------------------------------

SELECT *
FROM silver.crm_prd_info
WHERE prd_end_dt < prd_start_dt;

-- Preview Data
SELECT * FROM silver.crm_prd_info;

-- ============================================================================
-- Checking: silver.crm_sales_details
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Check for Unwanted Spaces in Order Number
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT sls_ord_num
FROM silver.crm_sales_details
WHERE sls_ord_num <> TRIM(sls_ord_num);

-- ---------------------------------------------------------------------------
-- Check for Invalid Dates in Bronze Layer
-- ---------------------------------------------------------------------------

SELECT sls_order_dt
FROM bronze.crm_sales_details
WHERE sls_order_dt <= 0 
   OR LEN(sls_order_dt) <> 8
   OR sls_order_dt > 20500101
   OR sls_order_dt < 19000101;

SELECT sls_ship_dt
FROM bronze.crm_sales_details
WHERE sls_ship_dt <= 0 
   OR LEN(sls_ship_dt) <> 8
   OR sls_ship_dt > 20500101
   OR sls_ship_dt < 19000101;

SELECT sls_due_dt
FROM bronze.crm_sales_details
WHERE sls_due_dt <= 0 
   OR LEN(sls_due_dt) <> 8
   OR sls_due_dt > 20500101
   OR sls_due_dt < 19000101;

-- ---------------------------------------------------------------------------
-- Check for Invalid Date Order
-- Expectation: Order date <= Ship date <= Due date
-- ---------------------------------------------------------------------------

SELECT *
FROM silver.crm_sales_details
WHERE sls_order_dt > sls_ship_dt
   OR sls_order_dt > sls_due_dt;

-- ---------------------------------------------------------------------------
-- Check Data Consistency Between Sales, Quantity & Price
-- Expectation:
--   Sales = Quantity * Price
--   Values must be positive and non-null
-- ---------------------------------------------------------------------------

SELECT DISTINCT 
    sls_sales,
    sls_quantity,
    sls_price
FROM silver.crm_sales_details
WHERE sls_sales <> sls_quantity * sls_price
   OR sls_sales IS NULL
   OR sls_quantity IS NULL
   OR sls_price IS NULL
   OR sls_sales <= 0
   OR sls_quantity <= 0
   OR sls_price <= 0;

-- ---------------------------------------------------------------------------
-- Data Cleaning Logic (Used Before Silver Load)
-- ---------------------------------------------------------------------------

SELECT DISTINCT 
    sls_sales AS old_sls_sales,
    sls_quantity,
    sls_price AS old_sls_price,

    CASE 
        WHEN sls_sales <> sls_quantity * sls_price 
             OR sls_sales IS NULL 
             OR sls_sales <= 0 
        THEN sls_quantity * ABS(sls_price)
        ELSE sls_sales
    END AS sls_sales,

    CASE 
        WHEN sls_price IS NULL OR sls_price <= 0 
        THEN sls_sales / NULLIF(sls_quantity, 0)
        ELSE sls_price
    END AS sls_price
FROM bronze.crm_sales_details
WHERE sls_sales <> sls_quantity * sls_price
   OR sls_sales IS NULL
   OR sls_quantity IS NULL
   OR sls_price IS NULL
   OR sls_sales <= 0
   OR sls_quantity <= 0
   OR sls_price <= 0;

-- Preview Data
SELECT * FROM silver.crm_sales_details;

-- ============================================================================
-- Checking: silver.erp_cust_az12
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Identify Out-of-Range Birth Dates
-- ---------------------------------------------------------------------------

SELECT bdate
FROM silver.erp_cust_az12
WHERE bdate < '1924-01-01'
   OR bdate > GETDATE();

-- ---------------------------------------------------------------------------
-- Data Standardization & Consistency
-- ---------------------------------------------------------------------------

SELECT DISTINCT gen
FROM silver.erp_cust_az12;

-- Preview Data
SELECT * FROM silver.erp_cust_az12;


-- ============================================================================
-- Checking: silver.erp_loc_a101
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Data Standardization & Consistency
-- ---------------------------------------------------------------------------

SELECT DISTINCT cntry
FROM silver.erp_loc_a101;

-- Preview Data
SELECT * FROM silver.erp_loc_a101;


-- ============================================================================
-- Checking: bronze.erp_px_cat_g1v2
-- ============================================================================

-- ---------------------------------------------------------------------------
-- Check for Unwanted Spaces
-- Expectation: No rows returned
-- ---------------------------------------------------------------------------

SELECT *
FROM bronze.erp_px_cat_g1v2
WHERE cat <> TRIM(cat)
   OR subcat <> TRIM(subcat)
   OR maintenance <> TRIM(maintenance);

-- ---------------------------------------------------------------------------
-- Data Standardization & Consistency
-- ---------------------------------------------------------------------------

SELECT DISTINCT cat
FROM bronze.erp_px_cat_g1v2;

SELECT DISTINCT subcat
FROM bronze.erp_px_cat_g1v2;

SELECT DISTINCT maintenance
FROM bronze.erp_px_cat_g1v2;

-- Preview Data
SELECT * FROM silver.erp_loc_a101;
